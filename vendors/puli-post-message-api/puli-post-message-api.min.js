function PuliPostMessageAPI(e){e=e?e:{};e="boolean"===typeof e.maunalReady?e.maunalReady:!1;let p;window.opener?p=window.opener:window.parent&&window.parent!==window&&(p=window.parent);let w=function(a){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(a,1):document.addEventListener("DOMContentLoaded",a)};p&&!1===e&&w(function(){t()});let t=function(){if(!0===u)return!1;u=!0;p.postMessage({eventName:"ready",url:location.href},"*")},u=!1,q={},r={},f={},l={},x=function(a){!1===
Array.isArray(f[a])&&(f[a]=[]);return new Promise(function(b,c){f[a].push(function(){b(!0)});if(1===f[a].length)f[a][0]()})},v=function(a){f[a].shift();0<f[a].length&&setTimeout(function(){f[a][0]()},0)},A=async function(a,b,c,d){await y(b);a().postMessage({eventName:"send",eventType:c,data:d,url:location.href},b);return new Promise(function(a,c){z(b,function(c){a(c)})})},g={},z=function(a,b){g[a]||(g[a]=[]);-1===g[a].indexOf(b)&&g[a].push(b)},B=function(a,b){if(!1===Array.isArray(g[a]))return!1;
g[a].forEach(function(a){if("function"!==typeof a)return!1;a(b)});g[a]=[];v(a);return!0},C=async function(a,b,c,d){if("function"===typeof n[c])c=await n[c](d);else return a.postMessage({eventName:"error",message:"sender's eventType is not found: "+c,url:location.href},b),!1;a.postMessage({eventName:"return",data:c,url:location.href},b)},y=function(a){return!0===q[a]?!0:new Promise(function(b,c){r[a]=function(){b(!0)}})};window.addEventListener("message",function(a){if("object"!==typeof a.data||!a.data.eventName)return!1;
let b=a.data.eventName,c=a.data.data,d=a.data.url,f=a.data.eventType,k=a.source;"return"===b?B(d,c):"send"===b?C(k,d,f,c):"ready"===b?(q[d]=!0,"function"===typeof r[d]&&(r[d](),delete r[d])):"error"===b&&(console.error(a.data.message),g[d]=[],v(d))},!0);let n={};return{send:async function(a,b,c){a=(new URL(a,document.baseURI)).href;await x(a);c=c?c:{};let {eventType:d,callback:f}=c;d=d?d:"default";let k="iframe";c&&c.mode&&(k=c.mode);let g=!1;c&&(!0===c.autoClose?g=c.autoClose:"undefined"===typeof c.autoClose&&
"popup"===c.mode&&(g=!1));if(!0===g&&l[a]){if("iframe"===k){var e=document.querySelector(`iframe[data-url="${a}"]`);null!==e&&e.parentNode.removeChild(e)}else"popup"===k&&l[a].close();delete q[a];delete l[a]}let m,h;if(l[a])m=l[a];else if("iframe"===k)h=document.querySelector(`iframe[data-url="${a}"]`),null===h&&(h=document.createElement("iframe"),h.style.display="none",h.src=a,h.setAttribute("data-url",a),document.body.appendChild(h));else if("popup"===k){e=void 0;c&&c.target&&(e=c.target);let b=
void 0;c&&c.features&&(b=c.features);m=window.open(a,e,b)}b=await A(function(){m||"iframe"!==k||(m=h.contentWindow);return m},a,d,b);!0===g?("iframe"===k?h&&h.parentNode.removeChild(h):m.close(),delete q[a],delete l[a]):l[a]||(l[a]=m);"function"===typeof f&&f(b);return b},addReceiveListener:function(a,b){"function"!==typeof a||b||(b=a,a="default");if("function"!==typeof b)return!1;n[a]=b},removeReceiveListener:function(a,b){"function"!==typeof a||b||(b=a,a="default");if("function"!==typeof b||!n[a])return!1;
delete n[a]},ready:function(){t()}}};