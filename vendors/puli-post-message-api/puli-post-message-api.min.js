function PuliPostMessageAPI(f){f=f?f:{};f="boolean"===typeof f.maunalReady?f.maunalReady:!1;let r;window.opener?r=window.opener:window.parent&&window.parent!==window&&(r=window.parent);let x=function(a){"complete"===document.readyState||"interactive"===document.readyState?setTimeout(a,1):document.addEventListener("DOMContentLoaded",a)};r&&!1===f&&x(function(){u()});let u=function(){if(!0===v)return!1;v=!0;r.postMessage({eventName:"ready",url:location.href},"*")},v=!1,p={},t={},e={},g={},y=function(a){!1===
Array.isArray(e[a])&&(e[a]=[]);return new Promise(function(b,c){e[a].push(function(){b(!0)});if(1===e[a].length)e[a][0]()})},w=function(a){e[a].shift();0<e[a].length&&setTimeout(function(){e[a][0]()},0)},B=async function(a,b,c,d){await z(b);a().postMessage({eventName:"send",eventType:c,data:d,url:location.href},b);return new Promise(function(a,c){A(b,function(c){a(c)})})},k={},A=function(a,b){k[a]||(k[a]=[]);-1===k[a].indexOf(b)&&k[a].push(b)},C=function(a,b){if(!1===Array.isArray(k[a]))return!1;
k[a].forEach(function(a){if("function"!==typeof a)return!1;a(b)});k[a]=[];w(a);return!0},D=async function(a,b,c,d){if("function"===typeof q[c])c=await q[c](d);else return a.postMessage({eventName:"error",message:"sender's eventType is not found: "+c,url:location.href},b),!1;a.postMessage({eventName:"return",data:c,url:location.href},b)},z=function(a){return!0===p[a]?!0:new Promise(function(b,c){t[a]=function(){b(!0)}})};window.addEventListener("message",function(a){if("object"!==typeof a.data||!a.data.eventName)return!1;
let b=a.data.eventName,c=a.data.data,d=a.data.url,g=a.data.eventType,e=a.source;"return"===b?C(d,c):"send"===b?D(e,d,g,c):"ready"===b?(p[d]=!0,"function"===typeof t[d]&&(t[d](),delete t[d])):"error"===b&&(console.error(a.data.message),k[d]=[],w(d))},!0);let q={};return{send:async function(a,b,c){a=(new URL(a,document.baseURI)).href;await y(a);c=c?c:{};let {eventType:d,callback:e,newWindow:k}=c;d=d?d:"default";let l="iframe";c&&c.mode&&(l=c.mode);let f=!1;c&&(!0===c.autoClose?f=c.autoClose:"undefined"===
typeof c.autoClose&&"popup"===c.mode&&(f=!1));if("popup"===l&&!0===k&&g[a])delete p[a],delete g[a];else if(!0===f&&g[a]){if("iframe"===l){var n=document.querySelector(`iframe[data-url="${a}"]`);null!==n&&n.parentNode.removeChild(n)}else"popup"===l&&g[a].close();delete p[a];delete g[a]}let m,h;if(g[a])m=g[a];else if("iframe"===l)h=document.querySelector(`iframe[data-url="${a}"]`),null===h&&(h=document.createElement("iframe"),h.style.display="none",h.src=a,h.setAttribute("data-url",a),document.body.appendChild(h));
else if("popup"===l){n=void 0;c&&c.target&&(n=c.target);let b=void 0;c&&c.features&&(b=c.features);m=window.open(a,n,b)}b=await B(function(){m||"iframe"!==l||(m=h.contentWindow);return m},a,d,b);!0===f?("iframe"===l?h&&h.parentNode.removeChild(h):m.close(),delete p[a],delete g[a]):g[a]||(g[a]=m);"function"===typeof e&&e(b);return b},addReceiveListener:function(a,b){"function"!==typeof a||b||(b=a,a="default");if("function"!==typeof b)return!1;q[a]=b},removeReceiveListener:function(a,b){"function"!==
typeof a||b||(b=a,a="default");if("function"!==typeof b||!q[a])return!1;delete q[a]},ready:function(){u()}}};